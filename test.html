<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ESP32-C3 WebBLE Controller</title>
<style>
  :root { --pad: 12px; --radius: 12px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: var(--pad); max-width: 900px; }
  header { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  h1 { font-size: 1.25rem; margin: 0; }
  #status { margin-left: auto; font-size: .9rem; opacity: .85; }
  .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
  .card { border: 1px solid #e8e8e8; border-radius: var(--radius); padding: var(--pad); margin-top: var(--pad); }
  button, input, select { padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; }
  button { cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,.06); }
  label { font-weight: 600; }
  #log { white-space: pre-wrap; border: 1px solid #eee; border-radius: 10px; padding: 10px; height: 160px; overflow: auto; background: #fafafa; }
  #pitch { font-variant-numeric: tabular-nums; font-size: 1.25rem; font-weight: 700; }
  .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f0f0f0; font-size: .8rem; }
  canvas { width: 100%; height: 200px; border: 1px solid #eee; border-radius: 10px; display: block; background: #fff; }
  .muted { opacity: .7; font-size: .9rem; }
</style>
<body>
<header>
  <h1>ESP32-C3 WebBLE Controller</h1>
  <span id="status" class="pill">Disconnected</span>
</header>

<div class="row" style="margin-top:8px">
  <button id="btnConnect">Connect</button>
  <button id="btnDisconnect">Disconnect</button>
  <button id="btnClear">Clear Log</button>
  <span class="muted">Device: <code id="devname">C3-PWM</code></span>
</div>

<div class="card">
  <div class="row">
    <div><label>Pitch:</label> <span id="pitch">–</span> °</div>
    <div class="muted">Print @ ESP: <span id="rate">60</span> Hz</div>
  </div>
  <canvas id="plot" width="800" height="200"></canvas>
</div>

<div class="card">
  <div class="row">
    <label>Freq (Hz)</label>
    <input id="freq" type="number" inputmode="numeric" value="100" style="width:110px" />
    <label>Duty (%)</label>
    <input id="duty" type="number" inputmode="numeric" value="50" style="width:90px" />
    <button id="btnStart">Start PWM</button>
    <button id="btnStop">Stop</button>
  </div>
</div>

<div class="card">
  <div class="row" style="margin-bottom:6px"><label>Angle Trigger</label>
    <input id="trigen" type="checkbox" />
    <label for="trigen" class="muted">Enable</label>
    <label>Threshold (°)</label>
    <input id="th" type="number" value="30" style="width:90px" />
    <span class="muted">Sends PWM when |pitch| ≥ threshold, STOP when it goes back.</span>
  </div>
</div>

<div class="card">
  <div class="row" style="margin-bottom:6px"><label>Quick Buttons</label><span class="muted">(edit in code)</span></div>
  <div id="quick" class="row"></div>
</div>

<div class="card">
  <div class="row" style="margin-bottom:6px"><label>Console</label></div>
  <div id="log"></div>
</div>

<script>
  // ---- Settings matching your ESP32 code ----
  const DEVICE_NAME = "C3-PWM";                 // advertise name
  const NUS_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e"; // UART service
  const NUS_TX      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // notify (ESP->phone)
  const NUS_RX      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // write  (phone->ESP)

  // Optional preset buttons (label + command)
  const PRESETS = [
    { label: "Start (inputs)", cmd: () => `PWM,${freqEl.value},${dutyEl.value}` },
    { label: "200 Hz @ 30%",   cmd: () => `PWM,200,30` },
    { label: "Stop",           cmd: () => `STOP` },
  ];

  // ---- UI elements ----
  const devnameEl = document.getElementById('devname');
  const statusEl = document.getElementById('status');
  const pitchEl = document.getElementById('pitch');
  const rateEl = document.getElementById('rate');
  const logEl = document.getElementById('log');
  const freqEl = document.getElementById('freq');
  const dutyEl = document.getElementById('duty');
  const trigEl = document.getElementById('trigen');
  const thEl = document.getElementById('th');
  const plot = document.getElementById('plot');
  const ctx = plot.getContext('2d');

  // Build quick buttons
  const quick = document.getElementById('quick');
  PRESETS.forEach(p => {
    const b = document.createElement('button'); b.textContent = p.label; b.onclick = () => sendLine(resolve(p.cmd)); quick.appendChild(b);
  });
  function resolve(val){ return (typeof val === 'function') ? val() : val; }

  function log(s){ logEl.textContent += s + "\n"; logEl.scrollTop = logEl.scrollHeight; }
  function setStatus(s){ statusEl.textContent = s; }

  // ---- BLE state ----
  let device, server, service, txChar, rxChar;
  let lastPitch = null;
  let lastEdgeState = null; // null/true/false
  let lastActionTs = 0;
  const debounceMs = 200;

  // ---- Plotting (simple rolling chart) ----
  const bufSize = 600; // ~10s at 60 Hz
  const ybuf = new Array(bufSize).fill(NaN);
  let idx = 0; // sample index
  function draw(){
    const w = plot.width, h = plot.height;
    ctx.clearRect(0,0,w,h);
    // axes
    ctx.strokeStyle = '#e5e5e5'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(40, 10); ctx.lineTo(40, h-20); ctx.lineTo(w-10, h-20); ctx.stroke();

    // compute y-range
    const vals = ybuf.filter(v => !Number.isNaN(v));
    let ymin=-90, ymax=90; // default
    if (vals.length){
      const mn = Math.min(...vals), mx = Math.max(...vals);
      const pad = Math.max(2, 0.1 * (mx - mn + 1e-6));
      ymin = mn - pad; ymax = mx + pad;
    }
    // zero line
    const y0 = mapY(0, ymin, ymax, h);
    ctx.strokeStyle = '#bbbbbb'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(40, y0); ctx.lineTo(w-10, y0); ctx.stroke(); ctx.setLineDash([]);

    // threshold line if enabled
    if (trigEl.checked){
      const th = Number(thEl.value)||30;
      const yy = mapY(th, ymin, ymax, h);
      const yyn = mapY(-th, ymin, ymax, h);
      ctx.strokeStyle = '#000000'; ctx.setLineDash([2,4]);
      ctx.beginPath(); ctx.moveTo(40, yy); ctx.lineTo(w-10, yy); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(40, yyn); ctx.lineTo(w-10, yyn); ctx.stroke();
      ctx.setLineDash([]);
    }

    // line plot
    ctx.strokeStyle = '#0b6bf2'; ctx.lineWidth = 2; ctx.beginPath();
    const vis = ybuf.map((v,i)=>[i,v]).filter(([,v])=>!Number.isNaN(v));
    for (let k=0;k<vis.length;k++){
      const i = vis[k][0]; const y = vis[k][1];
      const xpix = mapX(i, bufSize, w);
      const ypix = mapY(y, ymin, ymax, h);
      if (k===0) ctx.moveTo(xpix, ypix); else ctx.lineTo(xpix, ypix);
    }
    ctx.stroke();

    requestAnimationFrame(draw);
  }
  function mapX(i, N, w){ const left=40, right=w-10; return left + (i/N)*(right-left); }
  function mapY(v, ymin, ymax, h){ const top=10, bot=h-20; const t = (v - ymin)/(ymax - ymin + 1e-9); return bot - t*(bot-top); }
  requestAnimationFrame(draw);

  // ---- BLE connect/disconnect ----
  document.getElementById('btnConnect').onclick = connect;
  document.getElementById('btnDisconnect').onclick = disconnect;
  document.getElementById('btnClear').onclick = () => (logEl.textContent = "");
  document.getElementById('btnStart').onclick = () => sendLine(`PWM,${freqEl.value},${dutyEl.value}`);
  document.getElementById('btnStop').onclick  = () => sendLine('STOP');

  async function connect(){
    // If your firmware is advertising the NUS UUID in scan response, you can use service filter here.
    // Name filter is added to work with name-only advertising too.
    if (!('bluetooth' in navigator)) {
      alert('This browser does not support Web Bluetooth. On iOS, open this page in Bluefy or WebBLE.');
      return;
    }
    try{
      setStatus('Requesting…');
      device = await navigator.bluetooth.requestDevice({
        filters: [
          { name: DEVICE_NAME },           // finds "C3-PWM" by name
          { namePrefix: "C3-" }            // …or anything starting with C3-
          // You can ALSO add: { services: [NUS_SERVICE] } if your ADV/scan response includes it
        ],
        optionalServices: [NUS_SERVICE]
      });
      device.addEventListener('gattserverdisconnected', onDisconnected);
      devnameEl.textContent = device.name || DEVICE_NAME;
      setStatus('Connecting…');
      server = await device.gatt.connect();
      service = await server.getPrimaryService(NUS_SERVICE);
      txChar = await service.getCharacteristic(NUS_TX);
      rxChar = await service.getCharacteristic(NUS_RX);
      await txChar.startNotifications();
      txChar.addEventListener('characteristicvaluechanged', onNotify);
      setStatus('Connected');
      log('Connected to ' + (device.name||'ESP32-C3'));
    }catch(e){
      setStatus('Disconnected');
      log('Connect error: ' + e);
    }
  }
  function onDisconnected(){ setStatus('Disconnected'); log('Disconnected.'); }
  async function disconnect(){ try{ if(device?.gatt?.connected) device.gatt.disconnect(); }catch(e){ log('Disconnect error: '+e); } }

  // ---- notify/parse ----
  function onNotify(ev){
    const s = new TextDecoder().decode(ev.target.value).trim();
    if (!s) return;
    s.split(/\n+/).forEach(line => handleLine(line));
  }
  function handleLine(line){
    if (line.startsWith('PITCH,')){
      const v = parseFloat(line.split(',')[1]);
      if (!Number.isNaN(v)){
        pitchEl.textContent = v.toFixed(2);
        ybuf[idx % bufSize] = v; idx++;
        // trigger logic
        if (trigEl.checked){
          const th = Math.abs(Number(thEl.value)||30);
          const on = Math.abs(v) >= th;
          const now = Date.now();
          if (lastEdgeState === null) { lastEdgeState = on; if (on && now-lastActionTs>debounceMs) { sendLine(`PWM,${freqEl.value},${dutyEl.value}`); lastActionTs=now; } return; }
          if (on !== lastEdgeState && (now-lastActionTs>debounceMs)){
            if (on) sendLine(`PWM,${freqEl.value},${dutyEl.value}`); else sendLine('STOP');
            lastEdgeState = on; lastActionTs = now;
          }
        }
      }
    } else {
      log(line);
    }
  }

  // ---- send ----
  async function sendLine(s){
    if (!rxChar){ log('Not connected'); return; }
    try{
      const data = new TextEncoder().encode(s.endsWith('\n')?s:(s+'\n'));
      await rxChar.writeValue(data);
      log('> ' + s);
    }catch(e){ log('Write error: ' + e); }
  }

  // ---- iOS/Bluefy guidance ----
  (function iosHint(){
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    if (isIOS && !('bluetooth' in navigator)){
      log('Tip: On iOS, open this page in Bluefy or WebBLE to enable Web Bluetooth.');
    }
  })();
</script>
</body>
</html>
